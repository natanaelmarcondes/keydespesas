@model KeyDespesas.ViewModels.CategoriasVm

@{
    ViewData["Title"] = "Categorias";
    var returnUrl = (string?)ViewBag.ReturnUrl ?? Url.Action("Index", "Home");
}

<div class="dash-page dash-page--compact">

    <div class="dash-header">
        <div class="d-flex align-items-center justify-content-between">
            <div class="dash-welcome">
                <span class="dash-user-icon">
                    <i class="bi bi-tags-fill"></i>
                </span>

                <div>
                    <div class="dash-welcome-title">Cadastro</div>
                    <div class="dash-welcome-name">Categorias</div>
                </div>
            </div>

            <!-- VOLTAR -->
            <a class="btn btn-outline-secondary btn-sm" href="@returnUrl">
                <i class="bi bi-arrow-left me-1"></i>
                Voltar
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-lg-8 col-xl-7">

            <div class="card dash-card">
                <div class="card-body">

                    <!-- Topo -->
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div>
                            <div class="dash-card-title mb-1">Cadastro de categorias</div>
                        </div>

                        <span class="badge text-bg-light border">
                            @(Model.Lista?.Count ?? 0) itens
                        </span>
                    </div>

                    <!-- Form -->
                    <form asp-action="Salvar" method="post" class="row g-2 align-items-end">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="IdEdicao" />

                        <!-- ✅ returnUrl para voltar certo após salvar -->
                        <input type="hidden" name="returnUrl" value="@returnUrl" />

                        <div class="col-12 col-md-8">
                            <label class="form-label small mb-1">Nome</label>

                            <input asp-for="Nome"
                                   id="txtNomeCategoria"
                                   class="form-control form-control-sm"
                                   maxlength="80"
                                   placeholder="EX: ALIMENTACAO TRANSPORTE FATURA"
                                   autocomplete="off" />

                            <span asp-validation-for="Nome" class="text-danger small"></span>
                        </div>

                        <div class="col-12 col-md-4 d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm w-100">
                                <i class="bi bi-check2-circle me-1"></i>
                                @(Model.IdEdicao == 0 ? "Cadastrar" : "Salvar")
                            </button>

                            @if (Model.IdEdicao != 0)
                            {
                                <a class="btn btn-outline-secondary btn-sm w-100"
                                   asp-action="Cancelar"
                                   asp-route-returnUrl="@returnUrl">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Cancelar
                                </a>
                            }
                        </div>

                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div class="col-12">
                                <div class="alert alert-danger py-2 mb-0 small">
                                    Verifique os campos e tente novamente.
                                </div>
                            </div>
                        }
                    </form>

                    <hr class="my-3" />

                    <!-- Lista -->
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:90px;">Código</th>
                                    <th>Nome</th>
                                    <th style="width:160px;" class="text-end">Ações</th>
                                </tr>
                            </thead>

                            <tbody>
                                @if (Model.Lista == null || Model.Lista.Count == 0)
                                {
                                    <tr>
                                        <td colspan="3" class="text-muted small py-3">
                                            Nenhuma categoria cadastrada.
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    foreach (var item in Model.Lista)
                                    {
                                        <tr>
                                            <td class="text-muted">@item.Id</td>
                                            <td class="fw-semibold">@item.Nome</td>
                                            <td class="text-end">

                                                <a class="btn btn-outline-primary btn-sm"
                                                   asp-action="Index"
                                                   asp-route-editar="@item.Id"
                                                   asp-route-returnUrl="@returnUrl">
                                                    <i class="bi bi-pencil-square"></i>
                                                </a>

                                                <form asp-action="Excluir" method="post" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@item.Id" />
                                                    <input type="hidden" name="returnUrl" value="@returnUrl" />

                                                    <button type="submit"
                                                            class="btn btn-outline-danger btn-sm"
                                                            onclick="return confirm('Excluir a categoria @item.Nome ?');">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>

                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>

                        </table>
                    </div>

                </div>
            </div>

        </div>
    </div>

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {

            const txtNome = document.getElementById('txtNomeCategoria');
            if (!txtNome) return;

            // 🔹 Apenas letras + espaço e sempre MAIÚSCULO
            txtNome.addEventListener('input', function () {
                this.value = this.value
                    .toUpperCase()
                    .replace(/[^A-ZÀ-Ú\s]/g, '');
            });

            // 🔹 ENTER salva | ESC volta/cancela
            document.addEventListener('keydown', function (e) {

                // ENTER = salva (quando o foco está no campo)
                if (e.key === 'Enter' && document.activeElement === txtNome) {
                    const form = txtNome.closest('form');
                    if (form) {
                        e.preventDefault();
                        form.submit();
                    }
                }

                // ESC = se estiver editando, cancela; senão, volta
                if (e.key === 'Escape') {
                    const btnCancelar = document.querySelector('a[href*="Cancelar"]');
                    if (btnCancelar) {
                        e.preventDefault();
                        btnCancelar.click();
                        return;
                    }

                    const btnVoltar = document.querySelector('a.btn[href]');
                    if (btnVoltar) {
                        e.preventDefault();
                        btnVoltar.click();
                    }
                }
            });

            // 🔹 Foco automático
            setTimeout(() => txtNome.focus(), 200);

        })();
    </script>
}
