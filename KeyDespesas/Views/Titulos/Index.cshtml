@model KeyDespesas.ViewModels.TitulosVm

@{
    ViewData["Title"] = "Títulos";
    var returnUrl = (string?)ViewBag.ReturnUrl ?? Url.Action("Index", "Home");

    var atual = new DateTime(Model.Ano, Model.Mes, 1);
    var prev = atual.AddMonths(-1);
    var next = atual.AddMonths(1);
    var mesLabel = atual.ToString("MM/yyyy");

    var totalMes = (Model.Lista ?? new List<KeyDespesas.Models.Titulo>()).Sum(x => x.Valor);
    var totalPagar = (Model.Lista ?? new List<KeyDespesas.Models.Titulo>()).Where(x => x.Tipo == "P").Sum(x => x.Valor);
    var totalReceber = (Model.Lista ?? new List<KeyDespesas.Models.Titulo>()).Where(x => x.Tipo == "R").Sum(x => x.Valor);
    var saldoMes = totalReceber - totalPagar;
}

<div class="tit-page">
    <div class="tit-wrap">

        <!-- Cabeçalho (mantém suas infos/voltar) -->
        <div class="tit-head">
            <div class="d-flex align-items-center gap-3">
                <span class="dash-user-icon" style="width:46px;height:46px;border-radius:14px;display:inline-flex;align-items:center;justify-content:center;background:rgba(13,110,253,.10);border:1px solid rgba(13,110,253,.15);">
                    <i class="bi bi-receipt-cutoff" style="font-size:1.3rem;color:rgba(13,110,253,.85)"></i>
                </span>
                <div>
                    <div class="tit-title">Lançamentos — Títulos</div>
                    <div class="tit-sub">Competência: <strong>@mesLabel</strong></div>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2 flex-wrap">
                <div class="kd-kpis">
                    <div class="kd-kpi kd-kpi--ok text-end">
                        <div class="kd-kpi-title">Receber</div>
                        <div class="kd-kpi-value text-success">@totalReceber.ToString("N2")</div>
                    </div>

                    <div class="kd-kpi kd-kpi--bad text-end">
                        <div class="kd-kpi-title">Pagar</div>
                        <div class="kd-kpi-value text-danger">@totalPagar.ToString("N2")</div>
                    </div>

                    <div class="kd-kpi @(saldoMes >= 0 ? "kd-kpi--ok" : "kd-kpi--bad") text-end">
                        <div class="kd-kpi-title">Saldo</div>
                        <div class="kd-kpi-value @(saldoMes >= 0 ? "text-success" : "text-danger")">@saldoMes.ToString("N2")</div>
                    </div>
                </div>
                <a class="btn btn-outline-secondary tit-btn" href="@returnUrl">
                    <i class="bi bi-arrow-left me-1"></i> Voltar
                </a>
            </div>
        </div>

        <div class="card tit-card">
            <div class="card-body">

                <!-- Navegação por mês + contador -->
                <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
                    <div>
                        <div class="tit-title mb-0">Títulos do mês</div>
                        <div class="tit-sub">Gerencie pagar/receber com rapidez.</div>
                    </div>

                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <a class="btn btn-outline-secondary tit-btn"
                           asp-action="Index"
                           asp-route-ano="@prev.Year"
                           asp-route-mes="@prev.Month"
                           asp-route-returnUrl="@returnUrl"
                           title="Mês anterior">
                            <i class="bi bi-chevron-left"></i>
                        </a>

                        <a class="btn btn-outline-secondary tit-btn"
                           asp-action="Index"
                           asp-route-ano="@next.Year"
                           asp-route-mes="@next.Month"
                           asp-route-returnUrl="@returnUrl"
                           title="Mês seguinte">
                            <i class="bi bi-chevron-right"></i>
                        </a>

                        <span class="pill">
                            <i class="bi bi-list-check"></i>
                            @(Model.Lista?.Count ?? 0) itens
                        </span>
                    </div>
                </div>

                <!-- Form (maior e mais “web”) -->
                <form asp-action="Salvar" method="post" class="row g-3 align-items-end tit-form">
                    @Html.AntiForgeryToken()

                    <input type="hidden" asp-for="IdEdicao" />
                    <input type="hidden" name="returnUrl" value="@returnUrl" />
                    <input type="hidden" asp-for="Ano" />
                    <input type="hidden" asp-for="Mes" />

                    <div class="col-12 col-lg-2">
                        <label class="form-label mb-1">Tipo</label>
                        <select asp-for="Tipo" class="form-select">
                            <option value="P">Pagar</option>
                            <option value="R">Receber</option>
                        </select>
                    </div>

                    <div class="col-12 col-lg-5">
                        <label class="form-label mb-1">Descrição</label>
                        <input asp-for="Descricao"
                               id="txtDescricao"
                               class="form-control"
                               maxlength="150"
                               placeholder="EX: FATURA CARTÃO, ALUGUEL..."
                               autocomplete="off" />
                        <span asp-validation-for="Descricao" class="text-danger small"></span>
                    </div>

                    <div class="col-12 col-lg-3">
                        <label class="form-label mb-1">Categoria</label>
                        <select asp-for="IdCategoria" class="form-select" asp-items="Model.Categorias">
                            <option value="">Selecione</option>
                        </select>
                        <span asp-validation-for="IdCategoria" class="text-danger small"></span>
                    </div>

                    <div class="col-12 col-lg-2">
                        <label class="form-label mb-1">Valor</label>
                        <input asp-for="Valor"
                               id="txtValor"
                               class="form-control"
                               type="text"
                               inputmode="decimal"
                               placeholder="0,00"
                               autocomplete="off" />
                        <span asp-validation-for="Valor" class="text-danger small"></span>
                    </div>

                    <div class="col-12 col-lg-2">
                        <label class="form-label mb-1">Emissão</label>
                        <input asp-for="DataEmissao" class="form-control" type="date" />
                        <span asp-validation-for="DataEmissao" class="text-danger small"></span>
                    </div>

                    <div class="col-12 col-lg-2">
                        <label class="form-label mb-1">Vencimento</label>
                        <input asp-for="DataVencimento" class="form-control" type="date" />
                        <span asp-validation-for="DataVencimento" class="text-danger small"></span>
                    </div>

                    <div class="col-12 col-lg-3">
                        <label class="form-label mb-1">Status</label>
                        <select asp-for="Status" class="form-select">
                            <option value="ABERTO">ABERTO</option>
                            <option value="PAGO">PAGO</option>
                            <option value="CANCELADO">CANCELADO</option>
                            <option value="VENCIDO">VENCIDO</option>
                        </select>
                    </div>

                    <div class="col-12 col-lg-5 d-flex gap-2">
                        <button type="submit" class="btn btn-primary tit-btn flex-fill">
                            <i class="bi bi-check2-circle me-1"></i>
                            @(Model.IdEdicao == 0 ? "Cadastrar" : "Salvar")
                        </button>

                        @if (Model.IdEdicao != 0)
                        {
                            <a class="btn btn-outline-secondary tit-btn flex-fill"
                               asp-action="Cancelar"
                               asp-route-ano="@Model.Ano"
                               asp-route-mes="@Model.Mes"
                               asp-route-returnUrl="@returnUrl">
                                <i class="bi bi-x-circle me-1"></i>
                                Cancelar
                            </a>
                        }
                    </div>

                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="col-12">
                            <div class="alert alert-danger py-2 mb-0">
                                <strong>Atenção:</strong> verifique os campos e tente novamente.
                            </div>
                        </div>
                    }
                </form>

                <hr class="my-4" />

                <!-- Grid (moderno / suave) -->
                <!-- Grid (GLOBAL / padronizado) -->
                <div class="table-responsive kd-table-wrap">
                    <table class="table kd-table align-middle">
                        <thead>
                            <tr>
                                <th style="width:90px;">Código</th>
                                <th style="width:110px;">Tipo</th>
                                <th>Descrição</th>
                                <th style="width:140px;">Venc.</th>
                                <th style="width:140px;" class="text-end">Valor</th>
                                <th style="width:140px;">Status</th>
                                <th style="width:220px;" class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Lista == null || Model.Lista.Count == 0)
                            {
                                <tr>
                                    <td colspan="7" class="text-muted py-4">
                                        Nenhum título cadastrado no mês.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                foreach (var t in Model.Lista)
                                {
                                    <tr>
                                        <td class="text-muted">@t.Id</td>

                                        <td>
                                            @if (t.Tipo == "P")
                                            {
                                                <span class="pill pagar"><i class="bi bi-arrow-down-circle"></i> PAGAR</span>
                                            }
                                            else
                                            {
                                                <span class="pill receber"><i class="bi bi-arrow-up-circle"></i> RECEBER</span>
                                            }
                                        </td>

                                        <td class="fw-semibold">@t.Descricao</td>
                                        <td>@t.DataVencimento.ToString("dd/MM/yyyy")</td>
                                        <td class="text-end fw-bold">@t.Valor.ToString("N2")</td>
                                        <td><span class="pill">@t.Status</span></td>

                                        <!-- ✅ actions -> kd-actions -->
                                        <td class="text-end kd-actions">
                                            <a class="btn btn-outline-primary btn-sm"
                                               asp-action="Index"
                                               asp-route-editar="@t.Id"
                                               asp-route-ano="@Model.Ano"
                                               asp-route-mes="@Model.Mes"
                                               asp-route-returnUrl="@returnUrl"
                                               title="Editar">
                                                <i class="bi bi-pencil-square"></i>
                                            </a>

                                            <button type="button"
                                                    class="btn btn-outline-success btn-sm"
                                                    onclick="abrirCopiar(@t.Id)"
                                                    title="Copiar">
                                                <i class="bi bi-copy"></i>
                                            </button>

                                            <form asp-action="Excluir" method="post" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@t.Id" />
                                                <input type="hidden" name="returnUrl" value="@returnUrl" />
                                                <input type="hidden" name="ano" value="@Model.Ano" />
                                                <input type="hidden" name="mes" value="@Model.Mes" />

                                                <button type="submit"
                                                        class="btn btn-outline-danger btn-sm"
                                                        onclick="return confirm('Excluir o título @t.Descricao ?');"
                                                        title="Excluir">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>


            </div>
        </div>

    </div>
</div>

<!-- Modal Copiar Título (mantido) -->
<div class="modal fade" id="modalCopiar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">

            <form asp-action="Copiar" method="post">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h6 class="modal-title">Copiar título</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="id" id="copiar_id" />
                    <input type="hidden" name="returnUrl" value="@returnUrl" />
                    <input type="hidden" name="ano" value="@Model.Ano" />
                    <input type="hidden" name="mes" value="@Model.Mes" />

                    <label class="form-label mb-1">Novo vencimento</label>
                    <input type="date"
                           name="novoVencimento"
                           id="copiar_venc"
                           class="form-control"
                           required />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary tit-btn" data-bs-dismiss="modal">
                        Cancelar
                    </button>

                    <button type="submit" class="btn btn-success tit-btn">
                        <i class="bi bi-check2-circle me-1"></i> Copiar
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const txt = document.getElementById('txtDescricao');
            if (!txt) return;

            // Descrição sempre em MAIÚSCULO
            txt.addEventListener('input', function () {
                this.value = this.value.toUpperCase();
            });

            // Enter salva quando está no campo descrição
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && document.activeElement === txt) {
                    const form = txt.closest('form');
                    if (form) {
                        e.preventDefault();
                        form.submit();
                    }
                }
            });

            setTimeout(() => txt.focus(), 200);
        })();

        function abrirCopiar(id) {
            const idEl = document.getElementById('copiar_id');
            const vencEl = document.getElementById('copiar_venc');

            idEl.value = id;

            // Sugere amanhã como padrão
            const d = new Date();
            d.setDate(d.getDate() + 1);

            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');

            vencEl.value = `${yyyy}-${mm}-${dd}`;

            const modal = new bootstrap.Modal(document.getElementById('modalCopiar'));
            modal.show();

            setTimeout(() => vencEl.focus(), 150);
        }
    </script>
}
